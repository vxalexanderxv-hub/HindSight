<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deer Movement Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #111; color: #eee; font-family: sans-serif; }
    #map { height: 100vh; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px;
    }
    button { margin: 2px; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="darkToggle">üåô Dark</button>
    <button id="reload">üìç Reload My Location</button>
  </div>
  <div id="map"></div>

  <script>
    let map;
    let darkMode = true;

    function initMap(lat, lon) {
      if (map) { map.remove(); }
      map = L.map('map').setView([lat, lon], 14);

      const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });

      const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });

      dark.addTo(map);

      // Toggle dark/light mode
      document.getElementById("darkToggle").onclick = () => {
        darkMode = !darkMode;
        if (darkMode) {
          map.addLayer(dark); map.removeLayer(light);
        } else {
          map.addLayer(light); map.removeLayer(dark);
        }
      };

      // Fetch OSM landcover/trails via Overpass
      fetchOSMData(lat, lon);
    }

    function fetchOSMData(lat, lon) {
      const delta = 0.02; // ~2km bounding box
      const bbox = `${lat - delta},${lon - delta},${lat + delta},${lon + delta}`;

      const query = `
        [out:json][timeout:25];
        (
          way["landuse"](${bbox});
          way["natural"="wood"](${bbox});
          way["highway"="path"](${bbox});
        );
        out body;
        >;
        out skel qt;
      `;

      const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

      fetch(url)
        .then(r => r.json())
        .then(data => {
          L.geoJSON(osm2geojson(data), {
            style: f => ({
              color: f.properties.highway ? "red" : "green",
              weight: 1,
              opacity: 0.6
            })
          }).addTo(map);
        })
        .catch(err => {
          alert("OSM fetch failed: " + err);
        });
    }

    // Simple OSM JSON ‚Üí GeoJSON converter (lightweight)
    function osm2geojson(osmData) {
      const geojson = { type: "FeatureCollection", features: [] };
      const nodes = {};
      osmData.elements.forEach(el => {
        if (el.type === "node") nodes[el.id] = [el.lon, el.lat];
      });
      osmData.elements.forEach(el => {
        if (el.type === "way" && el.nodes) {
          const coords = el.nodes.map(n => nodes[n]).filter(Boolean);
          geojson.features.push({
            type: "Feature",
            geometry: {
              type: "LineString",
              coordinates: coords
            },
            properties: el.tags || {}
          });
        }
      });
      return geojson;
    }

    function getLocationAndInit() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => initMap(pos.coords.latitude, pos.coords.longitude),
          () => initMap(40.0, -95.0) // fallback: central US
        );
      } else {
        initMap(40.0, -95.0);
      }
    }

    document.getElementById("reload").onclick = getLocationAndInit;

    // Run on load
    getLocationAndInit();
  </script>
</body>
</html>